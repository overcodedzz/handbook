---
title:  "Docker"
categories: technology
header:
    image: /images/2019-08-06-docker/header.png
toc: true
---
## References
- [Docker Official Docs](https://docs.docker.com)
- S√°ch Docker Deep Dive
- https://viblo.asia/p/docker-chua-biet-gi-den-biet-dung-phan-1-lich-su-ByEZkWrEZQ0
- [Docker Tutorial for Beginners - YouTube](https://www.youtube.com/watch?v=fqMOX6JJhGo&ab_channel=TraversyMedia)



## Glossary
- namespaces: feature exists in Linux kernel
- control groups (cgroups): feature exists in Linux kernel
- daemon: a background process that handles requests for services such as print spooling and file transfers, and is dormant when not required.
- Image registries: the most common registry is Docker Hub
- Dangling image: an image that is no longer tagged, appears in <none>:<none>



## Advantages of Docker
- **Separate your applications from your infrastructure**, t·ª´ ƒë√≥ c√≥ th·ªÉ deploy nhanh ch√≥ng h∆°n.


## Installation
C√†i ƒë·∫∑t b·∫£n Community Docker, v·ªõi Mac v√† Win c·∫ßn c√†i Docker Desktop (VM ƒë·ªÉ ch·∫°y docker).

```bash
# check whether if Docker is installed.
docker version
```

You may need to add user account to group Docker to execute it without sudo.

## So s√°nh Virtualization vs Containerlization
Virtualization:
- V·ªÅ t√†i nguy√™n: khi ch·∫°y m√°y ·∫£o ph·∫£i cung c·∫•p dung l∆∞·ª£ng ·ªï c·ª©ng, c≈©ng nh∆∞ ram cho m√°y ·∫£o ƒë√≥.
- V·ªÅ th·ªùi gian: kh·ªüi ƒë·ªông, shutdown kh√° l√¢u.

Containerlization:
- Tr√™n m√°y ch·ªß v·∫≠t l√Ω s·∫Ω sinh ra ƒë∆∞·ª£c nhi·ªÅu m√°y con (gi·ªëng virtualization) nh∆∞ng t·ªët h∆°n ·ªü ch·ªó c√°c m√°y con (Guest OS) ƒë·ªÅu d√πng chung ph·∫ßn nh√¢n c·ªßa m√°y m·∫π (Host OS) v√† chia s·∫ª t√†i nguy√™n m√°y m·∫π.
-> Khi n√†o c·∫ßn t√†i nguy√™n th√¨ c·∫•p, c·∫ßn bao nhi√™u th√¨ c·∫•p b·∫•y nhi√™u -> t·∫≠n dung t√†i nguy√™n t·ªët h∆°n.

## Architecture of Docker
2 Major components:

- Docker client
- Docker daemon (or Docker engine)

The daemon implements the runtime, API and everything else required to run Docker.

Client g·ªçi Daemon th√¥ng qua local IPC/Unix socket ·ªü /var/run/docker.sock




Docker engine: the core software that runs and manages containers.

- modular in design, built from many small specialized tools. (ƒë√¢y l√† k·∫øt qu·∫£ c·ªßa qu√° tr√¨nh refactor nh·∫±m chia nh·ªè docker daemon).

![Docker%20f7723d3197124cc08906dd33e141a339/Untitled.png](Docker%20f7723d3197124cc08906dd33e141a339/Untitled.png)

![Docker%20f7723d3197124cc08906dd33e141a339/Untitled%201.png](Docker%20f7723d3197124cc08906dd33e141a339/Untitled%201.png)

runc: has a single purpose is to create containers. It's a standalone container runtime tool.

containerd: manage container lifecycle operations (start, stop, pause, rm,...) and some extended functionality (for images, volumes and networks) to make it easier to use in other projects. ‚Üíuse in k8s.

‚Üícontainer process is started as a child process of runc.

‚Üíentire container runtime is decoupled from the Docker daemon. ‚Üí "daemonless containers" ‚Üíc√≥ th·ªÉ upgrade daemon m√† kh√¥ng c·∫ßn t·∫Øt container.

![Docker%20f7723d3197124cc08906dd33e141a339/Untitled%202.png](Docker%20f7723d3197124cc08906dd33e141a339/Untitled%202.png)

Process behind running an image

Khi container ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o, th√¨ runc s·∫Ω exit. L√∫c n√†y, containerd-shim process s·∫Ω tr·ªü th√†nh parent c·ªßa container. Vai tr√≤ c·ªßa shim:

- Keeping any STDIN and STDOUT streams open so that when the daemon is restared, the container doesn't terminate due to pipes being closed.
- Reports the container's exit status back to the daemon.

Docker daemon: some major functionality still exists: image management, image builds, the REST API, authentication, security, core networking, and orchestration

## Working with Images
![Docker Images](/assets/images/docker/Untitled%203.png)

An image is just a bunch of loosely-connected read-only layers, with each layer comprising one or more files. Images don't contain kernel - all containers running on a Docker host share access to the host's kernel. One image can have several tags (tags point to the same image id).

Multi-architecture Images: h·∫ßu h·∫øt c√°c official image tr√™n Docker Hub ƒë·ªÅu h·ªó tr·ª£ multi-architecture m√† kh√¥ng c·∫ßn khai b√°o architecture.

```bash
docker image ls
docker pull [REPO:TAG]
docker search [QUERY_STRING]

# show all images
docker images

docker image inspect [IMAGE]

# delete image, you need to delete all dependent containers first
docker rmi <image>
# Delete all dangling images
docker image prune
# Delete all unused images (not currently used by any containers)
docker image prune -a

# Delete all images
docker image rm $(docker ls -q) -f


# RUN CONTAINER FROM AN IMAGE
docker run [IMAGE]
docker run -it [IMAGE]  # start a container
docker run -it [IMAGE] [CMD] # override the default command
# options:
# -i : interaction mode
# -d : detach mode
# -v <outside_volume>:<inside_volume> : mount volume
# -e MY_VAR=my_value : set envvars.
```

## Working with Containers
Docker sinh ra ƒë·ªÉ ch·∫°y application, ch·ª© kh√¥ng ch·∫°y ƒë·ªÉ host OS, n·∫øu kh√¥ng application n√†o th√¨ n√≥ s·∫Ω t·ª± ƒë·ªông exit. Docker s·∫Ω ch·∫°y ·ªü hai ch·∫ø ƒë·ªô attach v√† detach. V√† docker c≈©ng s·∫Ω kh√¥ng listen ·ªü stdin theo m·∫∑c ƒë·ªãnh (non-interact mode).

```bash
docker ps       # show running containers
docker ps -a    # show all containers

docker start/stop [CONTAINER]

docker rm [CONTAINER]

# execute a command
docker exec [CONTAINER] [COMMAND]

docker attach [CONTAINER]

# show full details of a container
docker inspect [CONTAINER]

docker logs [CONTAINER]
```


```bash
# Press Ctrl + P Q to exit the container without terminating it.

```


## Create my own image

### Dockerfile
Dockerfile l√† m·ªôt file text gi√∫p Docker t·∫°o image. M·ªói d√≤ng s·∫Ω bao g·ªìm 2 ph·∫ßn: instruction v√† argument. Sau m·ªói d√≤ng l·ªánh, m·ªôt layer s·∫Ω ƒë∆∞·ª£c t·∫°o ra ƒë·ªÉ cache. -> Kh√¥ng m·∫•t c√¥ng t·∫°o l·∫°i to√†n b·ªô khi c√≥ sai s√≥t.


V√≠ d·ª•:
```dockerfile
#
FROM Ubuntu

RUN apt-get update
RUN apt-get install python

RUN pip install flask
RUN pip install flask-mysql

COPY . /opt/source-code

ENTRYPOINT FLASK_APP=/opt/source-code/app.py flask run
```

T·∫•t c·∫£ image ph·∫£i base tr√™n m·ªôt base image kh√°c (OS).

```bash
# T·∫°o local image
docker build mydockerfile -t minhdq99hp/my-custom-image 

# ƒê·∫©y l√™n Docker Hub
docker push <custom_image>

```

#### Entrypoint vs Cmd
CMD: s·ª≠ d·ª•ng ƒë·ªÉ ch·∫°y default command khi container kh·ªüi ƒë·ªông

```dockerfile
CMD command param1
# or
CMD ["command", "param1"]
```

Ph·∫£i ƒë·∫£m b·∫£o r·∫±ng `"command"` ·ªü ƒë√¢y l√† m·ªôt executable app.
N·∫øu s·ª≠ d·ª•ng `docker run <image> [COMMAND]` th√¨ command kia s·∫Ω b·ªã override.

V√≠ d·ª•:
```dockerfile
FROM Ubuntu
CMD sleep 5
```

```bash
docker run <image> sleep 10
# --> override to "sleep 10"
```

V√≠ d·ª• s·ª≠ d·ª•ng Entrypoint:
```dockerfile
FROM Ubuntu
ENTRYPOINT ["sleep"]

# set default params
CMD ["5"]
```

```bash
docker run <image> 10

```

## Network
Khi t·∫°o container th√¨ n√≥ s·∫Ω c√≥ th·ªÉ c√≥ 3 ch·∫ø ƒë·ªô network: bridge (default), none, host

```bash
# bridge
docker run ubuntu
# none
docker run ubuntu --network
```

**Bridge**: private internal network created by docker on the host. All containers attach to this network, th∆∞·ªùng s·∫Ω c√≥ d·∫£i 172.17.0.xxx. C√°c container c√≥ th·ªÉ k·∫øt n·ªëi v·ªõi nhau th√¥ng qua d·∫£i n√†y.

**Host**: t·ª± ƒë·ªông mapping port, s·ª≠ d·ª•ng host network -> Kh√¥ng th·ªÉ s·ª≠ d·ª•ng container tr√πng port.

**None**: c√¥ l·∫≠p.


### User-defined networks
Docker c√≥ th·ªÉ chia nhi·ªÅu private internal network.

```bash
docker network create --driver bridge --subnet 182.18.0.0/16 <network_name>

docker network ls
```

### Embedded DNS
Docker h·ªó tr·ª£ relsove IP th√¥ng qua container name. DNS server ch·∫°y ·ªü 172.17.0.11




## Storage
Docker l∆∞u file t·∫°i `/var/lib/docker`. Docker ho·∫°t ƒë·ªông theo layered architecture. C√°c l·ªõp image s·∫Ω ƒë∆∞·ª£c t·∫°o th√¥ng qua dockerfile, khi ƒë√≥ n√≥ s·∫Ω tr·ªü th√†nh read-only. Khi ch·∫°y l·ªánh `docker run`, Docker s·∫Ω t·∫°o th√™m m·ªôt l·ªõp container layer, l·ªõp n√†y h·ªó tr·ª£ read-write, nh∆∞ng kh√¥ng persistent.

Gi·∫£ s·ª≠ n·∫øu m√¨nh copy source code v√†o trong image khi t·∫°o dockerfile th√¨ khi m√¨nh ch·ªânh s·ª≠a code, th·ª±c ra Docker ƒë√£ t·∫°o cho m√¨nh m·ªôt b·∫£n copy t·ª´ Image layers trong Container layers. Khi t·∫Øt container ƒëi th√¨ nh·ªØng th·ª© n·∫±m trong Container layers s·∫Ω b·ªã x√≥a s·∫°ch.

ƒê·ªÉ t·∫°o persistent storage, th√¨ m√¨nh c·∫ßn t·∫°o volume v√† k·∫øt n·ªëi v·ªõi container.

```bash
docker volume create <volume_name>
```

Khi ƒë√≥ volume s·∫Ω ƒë∆∞·ª£c t·∫°o ·ªü trong `/var/lib/docker/volumes/<volume_name>`. M√¨nh mount volume v√†o trong container b·∫±ng c√°ch:
```bash
docker run -v <volume_name>:<internal_endpoint> <image>
```

Ngo√†i ra, th√¨ volume kh√¥ng nh·∫•t thi·∫øt ph·∫£i ·ªü trong th∆∞ m·ª•c m·∫∑c ƒë·ªãnh c·ªßa Docker, m√¨nh c≈©ng c√≥ th·ªÉ mount volume ngo√†i b·∫±ng c√°ch specific absolute path c·ªßa n√≥. (C√°ch n√†y g·ªçi l√† bind mounting).

S·ª≠ d·ª•ng option `-v` ƒë√£ c≈© r·ªìi, gi·ªù ng∆∞·ªùi ta hay s·ª≠ d·ª•ng `--mount`:
```bash
docker run --mount type=bind,source=<external_volume>,target=<internal_volume> <image>
```


## Dockerfile
Example:
```docker
FROM alpine
LABEL maintainer="nigelpoulton@hotmail.com"
RUN apk add --update nodejs nodejs-npm
COPY . /src
WORKDIR /src
RUN npm install
EXPOSE 8080
ENTRYPOINT ["node", "./app.js"]
```

Build new image
```bash
docker build [CONTEXT_PATH]
docker build [CONTEXT_PATH] -t [IMAGE_NAME:TAG]

# E.g:
# docker build -t my_img:latest .
```




## dockerignore
.dockerignore file

Th∆∞·ªùng th√¨ s·∫Ω ignore folder .git v√† .env

```docker
build:
  context: .
  dockerfile: DockerFilePython
```

Kinh nghi·ªám t·∫°o Docker image:

```docker
FROM python:3.8

ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

RUN apt-get update
RUN apt-get install ffmpeg -y

WORKDIR /code

COPY requirements.txt /code/

RUN pip install -r requirements.txt

COPY . /code/
```

Khi t·∫°o Docker image th√¨ lu√¥n ƒë·ªÉ nh·ªØng th√†nh ph·∫ßn thay ƒë·ªïi nhi·ªÅu xu·ªëng b√™n d∆∞·ªõi. ·ªû v√≠ d·ª• tr√™n, c·∫ßn copy requirements.txt v√†o tr∆∞·ªõc c≈©ng v√¨ th·∫ø.




## Docker Compose
Thay v√¨ ch·∫°y t·ª´ng l·ªánh `docker run` ri√™ng l·∫ª kia th√¨ ta c√≥ th·ªÉ s·ª≠ d·ª•ng Docker compose. V·ªÅ c∆° b·∫£n th√¨ l√† t·∫°o m·ªôt file `docker-compose.yml`, trong ƒë√≥ li·ªát k√™ c√°c service k√®m theo setting c·∫ßn t·∫°o.

Xong ƒë√≥ ch·∫°y l·ªánh n√†y l√† to√†n b·ªô service s·∫Ω ƒë∆∞·ª£c b·∫≠t.
```bash
docker-compose up
```

### Docker compose -build
C√°c service ƒë·ªãnh nghƒ©a ·ªü trong docker-compose kh√¥ng nh·∫•t thi·∫øt ph·∫£i c√≥ s·∫µn image ·ªü local ho·∫∑c Docker Hub.

V√≠ d·ª•:
```yml
vote:
    build: ./vote
    ports:
        - 5000:80
    links:
        - redis
```

Docker s·∫Ω build image th√¥ng qua dockerfile ·ªü trong th∆∞ m·ª•c `vote/` v√† t·∫°o temp container ƒë·ªÉ ch·∫°y.



## Docker Registry
- Public docker registry
- Private docker registry


## Docker Engine
By default, Docker doesn't limit


Limit CPU:
```bash
docker run --cpus=.5 <image>
```

Limit Memory:
```bash
docker run --mem=100 <image>
```


## Container orchestration
Contaier orchestration: solution that contain a set of tools and scripts that help monitoring, deploying containers efficiently.

Docker Swarm
Kubernetes (most popular)
Mesos


## Best Practices

### Bring source code into Docker container
C√≥ 3 c√°ch ph·ªï bi·∫øn ƒë·ªÉ ƒë∆∞a source code v√†o trong docker container:
- S·ª≠ d·ª•ng Git Clone
- S·ª≠ d·ª•ng COPY
- S·ª≠ d·ª•ng Volume

ƒê·∫ßu ti√™n l√† s·ª≠ d·ª•ng git clone. ∆Øu ƒëi·ªÉm l√† vi·∫øt dockerfile kh√° d·ªÖ hi·ªÉu, h·∫øtüôÇ Nh∆∞·ª£c ƒëi·ªÉm l√† m·ªói l·∫ßn build image ƒë·ªÅu ph·∫£i rebuild l·∫°i, kh√¥ng ƒë·∫£m b·∫£o ƒë∆∞·ª£c b·∫£o m·∫≠t khi truy·ªÅn v√†o credentials (c√≥ c√°ch work around c∆° m√† s·∫Ω ph·ª©c t·∫°p h∆°n). C√°ch n√†y ch·ªâ n√™n d√πng v·ªõi c√°c project d·∫°ng open-source.

C√°ch th·ª© hai l√† s·ª≠ d·ª•ng COPY, nh∆∞·ª£c ƒëi·ªÉm v·∫´n l√† ph·∫£i rebuild l·∫°i image (khi code thay ƒë·ªïi). ∆Øu ƒëi·ªÉm h∆°n l√† kh√¥ng ph·∫£i c√†i Git, b·∫£o ƒë·∫£m b·∫£o m·∫≠t h∆°n. C√°ch n√†y kh√° ph·ªï bi·∫øn, chuy√™n d√πng ƒë·ªÉ t·∫°o production image. Ng∆∞·ªùi nh·∫≠n ch·ªâ c·∫ßn ch·∫°y dockerfile thay v√¨ ph·∫£i l·∫•y code v·ªÅ.

C√°ch cu·ªëi c√πng l√† s·ª≠ d·ª•ng Volume, thay v√¨ copy code v√†o trong image th√¨ m√¨nh ch·ªâ c·∫ßn mount th∆∞ m·ª•c project v√†o trong docker. M·ªçi thay ƒë·ªïi ·ªü code s·∫Ω hi·ªán di·ªán lu√¥n trong container (server c√≥ th·ªÉ hot reload ƒë∆∞·ª£c). C√°ch n√†y th√¨ ph√π h·ª£p l√†m development image, gi·∫£m th·ªùi gian ƒëi build image r·∫•t r·∫•t nhi·ªÅu. 



Kubernetes is the most popular tool for deploying and managing containerized apps. Kubernetes has a pluggable container runtime interface (CRI) that makes it easy to swap-out Docker for a different container runtime. ‚ÜíDocker has been replaced by containerd as the default container runtime in Kubernetes. 

ƒê·ªçc th√™m The Kubernetes Book